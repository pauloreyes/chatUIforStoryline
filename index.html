<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Storyline Chat Interaction</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			:root {
				--bg-color: #f0f2f5;
				--user-bubble: #0084ff;
				--bot-bubble: #e4e6eb;
				--user-text: #ffffff;
				--bot-text: #050505;
				--timestamp-color: #65676b;
			}

			body {
				margin: 0;
				padding: 0;
				background-color: var(--bg-color);
				font-family:
					Segoe UI,
					Roboto,
					Helvetica,
					Arial,
					sans-serif;
				height: 100vh;
				display: flex;
				flex-direction: column;
				overflow: hidden;
				border: 1px solid #ddd;
			}

			#chat-container {
				flex-grow: 1;
				overflow-y: auto;
				padding: 2rem;
				display: flex;
				flex-direction: column;
				gap: 12px;
				scrollbar-width: none;
			}

			#chat-container::-webkit-scrollbar {
				display: none;
			}

			.message-wrapper {
				display: flex;
				flex-direction: column;
				margin-bottom: 24px;
				max-width: 85%;
			}

			.message-wrapper.user {
				align-self: flex-end;
				align-items: flex-end;
			}

			.message-wrapper.bot {
				align-self: flex-start;
				align-items: flex-start;
			}

			.sender-name {
				font-size: 24px;
				font-weight: 600;
				color: var(--timestamp-color);
				margin-bottom: 6px;
				margin-left: 20px;
				margin-right: 20px;
			}

			.bubble {
				padding: 20px 32px;
				border-radius: 35px;
				font-size: 32px;
				line-height: 1.4;
				word-wrap: break-word;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				white-space: pre-wrap;
			}

			.message-wrapper.user .bubble {
				background-color: var(--user-bubble);
				color: var(--user-text);
				border-bottom-right-radius: 8px;
			}

			.message-wrapper.bot .bubble {
				background-color: var(--bot-bubble);
				color: var(--bot-text);
				border-bottom-left-radius: 4px;
			}

			.timestamp {
				font-size: 20px;
				color: var(--timestamp-color);
				margin-top: 8px;
				opacity: 0.8;
			}

			.typing-indicator {
				display: none;
				padding: 20px 32px;
				background: var(--bot-bubble);
				border-radius: 35px;
				border-bottom-left-radius: 8px;
				margin-left: 1rem;
				margin-bottom: 1.5rem;
				width: fit-content;
			}

			.dot {
				display: inline-block;
				width: 12px;
				height: 12px;
				background-color: #90949c;
				border-radius: 50%;
				margin-right: 6px;
				animation: wave 1.3s linear infinite;
			}

			.dot:nth-child(2) {
				animation-delay: -1.1s;
			}

			.dot:nth-child(3) {
				animation-delay: -0.9s;
			}

			@keyframes wave {
				0%,
				60%,
				100% {
					transform: translateY(0);
				}

				30% {
					transform: translateY(-8px);
				}
			}

			@keyframes popIn {
				from {
					transform: scale(0.95);
					opacity: 0;
				}

				to {
					transform: scale(1);
					opacity: 1;
				}
			}

			.animate-pop {
				animation: popIn 0.2s ease-out forwards;
			}

			#input-area {
				background-color: white;
				padding: 24px 36px;
				border-top: 1px solid #ddd;
				display: flex;
				align-items: center;
				gap: 20px;
			}

			#user-input {
				flex-grow: 1;
				background-color: #f0f2f5;
				border: none;
				border-radius: 40px;
				padding: 16px 32px;
				font-size: 30px;
				outline: none;
			}

			#send-btn {
				color: var(--user-bubble);
				font-weight: 600;
				font-size: 30px;
				cursor: pointer;
				transition: opacity 0.2s;
				background: none;
				border: none;
			}

			#send-btn:disabled {
				opacity: 0.3;
				cursor: default;
			}

			#api-status {
				position: fixed;
				top: 10px;
				right: 10px;
				font-size: 14px;
				padding: 4px 10px;
				border-radius: 10px;
				background: #dcfce7;
				color: #166534;
				font-weight: bold;
				pointer-events: none;
				z-index: 100;
			}

			#api-status.ready {
				background: #dcfce7;
				color: #166534;
			}
		</style>
	</head>

	<body>
		<div id="api-status">Ready</div>
		<div id="chat-container"></div>

		<div id="typing" class="typing-indicator">
			<span class="dot"></span>
			<span class="dot"></span>
			<span class="dot"></span>
		</div>

		<div id="input-area">
			<input type="text" id="user-input" placeholder="Type a message..." autocomplete="off" />
			<button id="send-btn" disabled>Send</button>
		</div>

		<script>
			// ========== TOGGLE SETTINGS ==========
			// Set to true to show the message, false to hide it
			const SHOW_SESSION_STARTED_MSG = false; // "Session started." message
			const SHOW_PERSONA_ACTIVE_MSG = false; // "Customer persona active." message
			const SHOW_COMMAND_HELP_MSG = false; // Command help instructions
			const SHOW_INITIAL_MESSAGES = true; // Initial conversation messages

			// ========== RESPONSE LIMIT SETTINGS ==========
			const MAX_RESPONSES = 10; // Max learner responses before feedback. Set to 999 to disable limit and hide counter.
			// ======================================

			// ========== INITIAL CONVERSATION ==========
			// Configure the dummy messages to show at the start
			// Each message has a "sender" (use "user" for learner, anything else for customer)
			// and "text" for the message content
			// example: { sender: "user", text: "Hello! I'd be happy to help you with that. Could you please provide me with your name and account information?" }
			const INITIAL_MESSAGES = [
				{
					sender: "Customer",
<<<<<<< HEAD
					text: "It doesn't matter anymore. The account, the limits... none of that is relevant now. The money is gone and I feel trapped. There's no point in trying to fix it.",
=======
					text: "I NEED URGENT ASSISTANCE! I CANNOT MAKE A DEPOSIT! PLEASE HELP!",
>>>>>>> aaaf8cac7b9e2043f381397c38b71320c920e731
				},
			];
			// ===========================================

			const container = document.getElementById("chat-container");
			const typingIndicator = document.getElementById("typing");
			const userInput = document.getElementById("user-input");
			const sendBtn = document.getElementById("send-btn");
			const apiStatus = document.getElementById("api-status");

			function generateSessionId() {
				return Date.now().toString() + Math.random().toString(36).substring(2);
			}
			let sessionId = generateSessionId();
			let chatHistory = [];
			let isCoachingMode = false;
			let responseCount = 0;

			/**
			 * Loads initial conversation messages into the UI and chat history
			 */
			function loadInitialMessages() {
				if (!SHOW_INITIAL_MESSAGES || INITIAL_MESSAGES.length === 0) return;

				INITIAL_MESSAGES.forEach((msg) => {
					// Add to UI
					window.addChatMessage(msg.sender, msg.text);
<<<<<<< HEAD
=======

					// Add to chat history for AI context
					const role = msg.sender.toLowerCase() === "user" ? "user" : "model";
					chatHistory.push({ role: role, parts: [{ text: msg.text }] });
>>>>>>> aaaf8cac7b9e2043f381397c38b71320c920e731
				});
			}

			function getCurrentTime() {
				const now = new Date();
				return now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
			}

			/**
			 * Clears history and UI
			 */
			window.clearChat = function () {
				container.innerHTML = "";
				chatHistory = [];
				sessionId = generateSessionId();
				isCoachingMode = false;
				responseCount = 0;
				// Clear completion flag on restart
				localStorage.setItem("chat_activity_complete", "false");
			};

			/**
			 * Displays the slash command instructions
			 */
			function showCommandHelp() {
				const helpMsg =
					"Commands available:\n/feedback - Switch to Coaching Mode\n/chat - Return to simulation\n/restart - Clear history and start over";
				window.addChatMessage("System", helpMsg);
			}

			window.addChatMessage = function (sender, text) {
				typingIndicator.style.display = "none";
				const isUser = sender.toLowerCase() === "user";
				const wrapper = document.createElement("div");
				wrapper.className = `message-wrapper ${isUser ? "user" : "bot"} animate-pop`;

				const label = document.createElement("div");
				label.className = "sender-name";
				label.innerText = isUser ? "You" : sender;
				wrapper.appendChild(label);

				const bubble = document.createElement("div");
				bubble.className = "bubble";
				bubble.innerText = text;
				wrapper.appendChild(bubble);

				const time = document.createElement("div");
				time.className = "timestamp";
				time.innerText = getCurrentTime();
				wrapper.appendChild(time);

				if (isUser && !isCoachingMode && MAX_RESPONSES !== 999) {
					const count = document.createElement("div");
					count.className = "timestamp";
					count.innerText = `${responseCount + 1} of ${MAX_RESPONSES}`;
					wrapper.appendChild(count);
				}

<<<<<<< HEAD
				// Add to local transcript tracking
				chatHistory.push({ sender: sender, text: text, timestamp: getCurrentTime() });

=======
>>>>>>> aaaf8cac7b9e2043f381397c38b71320c920e731
				container.appendChild(wrapper);
				container.scrollTop = container.scrollHeight;
			};

			window.showTyping = function () {
				typingIndicator.style.display = "block";
				container.scrollTop = container.scrollHeight;
			};

			const N8N_WEBHOOK_URL =
				"https://n8n.pochwork.com/webhook/5ece6ab9-7d99-4d50-a275-1e95630a3b93/chat";

			async function fetchAIResponse(userPrompt) {
				const cmd = userPrompt.trim().toLowerCase();

				// Increment response count for learner messages (not commands)
				if (!cmd.startsWith("/") && !isCoachingMode) {
					responseCount++;
					if (MAX_RESPONSES !== 999 && responseCount >= MAX_RESPONSES) {
						window.addChatMessage(
							"System",
							"Maximum response limit reached. Triggering feedback..."
						);
						fetchGeminiResponse("/feedback");
						return;
					}
				}

				// Slash Command: Feedback
				if (cmd === "/feedback") {
					isCoachingMode = true;
					window.addChatMessage("System", "Switching to Coaching Mode...");
					userPrompt =
						"Please analyze my performance in this conversation so far and provide constructive feedback.";
				}
				// Slash Command: Chat
				else if (cmd === "/chat") {
					isCoachingMode = false;
					window.addChatMessage("System", "Returning to simulation...");
					return;
				}
				// Slash Command: Restart
				else if (cmd === "/restart") {
					window.clearChat();
					window.addChatMessage("System", "Conversation restarted. Memory cleared.");
<<<<<<< HEAD
=======
					// Reload initial conversation messages
>>>>>>> aaaf8cac7b9e2043f381397c38b71320c920e731
					loadInitialMessages();
					return;
				}

				// Increment response count ONLY in simulation mode and for non-commands
				if (!cmd.startsWith("/") && !isCoachingMode) {
					responseCount++;
					if (MAX_RESPONSES !== 999 && responseCount >= MAX_RESPONSES) {
						window.addChatMessage(
							"System",
							"Maximum response limit reached. Triggering feedback...",
						);
						fetchAIResponse("/feedback");
						return;
					}
				}

				window.showTyping();

				const aiLabel = isCoachingMode ? "CoachingAI" : "Customer";

				const payload = {
					chatInput: userPrompt,
					message: userPrompt,
					sessionId: sessionId,
					mode: isCoachingMode ? "feedback" : "simulation",
					isCoachingMode: isCoachingMode,
					responseCount: responseCount,
					maxResponses: MAX_RESPONSES,
				};

				// If this is the first message of a new session, send the visible initial messages as context
				if (responseCount === 1) {
					payload.initialContext = chatHistory
						.filter((m) => m.sender !== "System")
						.slice(0, -1);
				}

				// Include full transcript ONLY when sending to the coaching agent
				if (isCoachingMode) {
					payload.transcript = chatHistory;
				}

				try {
					const response = await fetch(N8N_WEBHOOK_URL, {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify(payload),
					});

					if (!response.ok) {
						throw new Error(`Status: ${response.status}`);
					}

					let result;
					const contentType = response.headers.get("content-type");
					if (contentType && contentType.includes("application/json")) {
						result = await response.json();
					} else {
						const text = await response.text();
						result = { output: text };
					}

					// Expecting response in result.output, result.response, result.text, or result.message
					const aiText =
						result.output ||
						result.response ||
						result.text ||
						result.message ||
						(Array.isArray(result) ? result[0].output : null) ||
						(typeof result === "string" ? result : "No response received.");

					window.addChatMessage(aiLabel, aiText);

					// Update Storyline via localStorage if feedback was successfully given
					if (isCoachingMode) {
						localStorage.setItem("chat_activity_complete", "true");
					}
				} catch (error) {
					console.error("Error calling n8n:", error);
					window.addChatMessage("System", `Communication Error. Please try again.`);
				}
			}

			function handleSend() {
				const text = userInput.value.trim();
				if (text) {
					const cmd = text.toLowerCase();
					// Pre-emptively switch mode for UI counter accuracy
					if (cmd === "/feedback") isCoachingMode = true;
					if (cmd === "/chat") isCoachingMode = false;

					window.addChatMessage("user", text);
					userInput.value = "";
					sendBtn.disabled = true;
					fetchAIResponse(text);
				}
			}

			userInput.addEventListener("input", () => {
				sendBtn.disabled = !userInput.value.trim();
			});

			userInput.addEventListener("keypress", (e) => {
				if (e.key === "Enter") handleSend();
			});

			sendBtn.addEventListener("click", handleSend);

			function handleInboundAction(data) {
<<<<<<< HEAD
				if (data.action === "addMessage") {
=======
				if (data.action === "setApiKey" || (data.key && !data.action)) {
					apiKey = data.key;
					apiStatus.innerText = "Connected";
					apiStatus.className = "ready";
					if (SHOW_SESSION_STARTED_MSG) {
						window.addChatMessage("System", "Session started.");
					}
				} else if (data.action === "setSystemPrompt") {
					systemPrompt = data.text;
					if (SHOW_PERSONA_ACTIVE_MSG) {
						window.addChatMessage("System", "Customer persona active.");
					}
					// Show help after initialization messages
					if (SHOW_COMMAND_HELP_MSG) {
						showCommandHelp();
					}
					// Load initial conversation messages
					loadInitialMessages();
				} else if (data.action === "setCoachPersona") {
					coachPersona = data.text;
				} else if (data.action === "addMessage") {
>>>>>>> aaaf8cac7b9e2043f381397c38b71320c920e731
					window.addChatMessage(data.sender, data.text);
				} else if (data.action === "showTyping") {
					window.showTyping();
				} else if (data.action === "clear") {
					window.clearChat();
				}
			}

			window.addEventListener("message", function (event) {
				handleInboundAction(event.data);
			});

			// Initialize localStorage flag
			localStorage.setItem("chat_activity_complete", "false");

			// Load initial conversation messages on startup
			loadInitialMessages();

			// Show help if enabled
			if (SHOW_COMMAND_HELP_MSG) {
				showCommandHelp();
			}
		</script>
	</body>
</html>
