<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Storyline Chat Interaction</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			:root {
				--bg-color: #f0f2f5;
				--user-bubble: #0084ff;
				--bot-bubble: #e4e6eb;
				--user-text: #ffffff;
				--bot-text: #050505;
				--timestamp-color: #65676b;
			}

			body {
				margin: 0;
				padding: 0;
				background-color: var(--bg-color);
				font-family: Segoe UI, Roboto, Helvetica, Arial, sans-serif;
				height: 100vh;
				display: flex;
				flex-direction: column;
				overflow: hidden;
				border: 1px solid #ddd;
			}

			#chat-container {
				flex-grow: 1;
				overflow-y: auto;
				padding: 2rem;
				display: flex;
				flex-direction: column;
				gap: 12px;
				scrollbar-width: none;
			}

			#chat-container::-webkit-scrollbar {
				display: none;
			}

			.message-wrapper {
				display: flex;
				flex-direction: column;
				margin-bottom: 24px;
				max-width: 85%;
			}

			.message-wrapper.user {
				align-self: flex-end;
				align-items: flex-end;
			}
			.message-wrapper.bot {
				align-self: flex-start;
				align-items: flex-start;
			}

			.sender-name {
				font-size: 24px;
				font-weight: 600;
				color: var(--timestamp-color);
				margin-bottom: 6px;
				margin-left: 20px;
				margin-right: 20px;
			}

			.bubble {
				padding: 20px 32px;
				border-radius: 35px;
				font-size: 32px;
				line-height: 1.4;
				word-wrap: break-word;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				white-space: pre-wrap;
			}

			.message-wrapper.user .bubble {
				background-color: var(--user-bubble);
				color: var(--user-text);
				border-bottom-right-radius: 8px;
			}

			.message-wrapper.bot .bubble {
				background-color: var(--bot-bubble);
				color: var(--bot-text);
				border-bottom-left-radius: 4px;
			}

			.timestamp {
				font-size: 20px;
				color: var(--timestamp-color);
				margin-top: 8px;
				opacity: 0.8;
			}

			.typing-indicator {
				display: none;
				padding: 20px 32px;
				background: var(--bot-bubble);
				border-radius: 35px;
				border-bottom-left-radius: 8px;
				margin-left: 1rem;
				margin-bottom: 1.5rem;
				width: fit-content;
			}

			.dot {
				display: inline-block;
				width: 12px;
				height: 12px;
				background-color: #90949c;
				border-radius: 50%;
				margin-right: 6px;
				animation: wave 1.3s linear infinite;
			}

			.dot:nth-child(2) {
				animation-delay: -1.1s;
			}
			.dot:nth-child(3) {
				animation-delay: -0.9s;
			}

			@keyframes wave {
				0%,
				60%,
				100% {
					transform: translateY(0);
				}
				30% {
					transform: translateY(-8px);
				}
			}

			@keyframes popIn {
				from {
					transform: scale(0.95);
					opacity: 0;
				}
				to {
					transform: scale(1);
					opacity: 1;
				}
			}

			.animate-pop {
				animation: popIn 0.2s ease-out forwards;
			}

			#input-area {
				background-color: white;
				padding: 24px 36px;
				border-top: 1px solid #ddd;
				display: flex;
				align-items: center;
				gap: 20px;
			}

			#user-input {
				flex-grow: 1;
				background-color: #f0f2f5;
				border: none;
				border-radius: 40px;
				padding: 16px 32px;
				font-size: 30px;
				outline: none;
			}

			#send-btn {
				color: var(--user-bubble);
				font-weight: 600;
				font-size: 30px;
				cursor: pointer;
				transition: opacity 0.2s;
				background: none;
				border: none;
			}

			#send-btn:disabled {
				opacity: 0.3;
				cursor: default;
			}

			#api-status {
				position: fixed;
				top: 10px;
				right: 10px;
				font-size: 14px;
				padding: 4px 10px;
				border-radius: 10px;
				background: #fee2e2;
				color: #991b1b;
				font-weight: bold;
				pointer-events: none;
				z-index: 100;
			}

			#api-status.ready {
				background: #dcfce7;
				color: #166534;
			}
		</style>
	</head>
	<body>
		<div id="api-status">Key Missing</div>
		<div id="chat-container"></div>

		<div id="typing" class="typing-indicator">
			<span class="dot"></span>
			<span class="dot"></span>
			<span class="dot"></span>
		</div>

		<div id="input-area">
			<input type="text" id="user-input" placeholder="Type a message..." autocomplete="off" />
			<button id="send-btn" disabled>Send</button>
		</div>

		<script>
			const container = document.getElementById("chat-container");
			const typingIndicator = document.getElementById("typing");
			const userInput = document.getElementById("user-input");
			const sendBtn = document.getElementById("send-btn");
			const apiStatus = document.getElementById("api-status");

			let apiKey = "";
			let systemPrompt = "You are a helpful assistant.";
			let coachPersona =
				"You are a coaching AI. Analyze the performance and provide feedback.";
			let chatHistory = [];
			let isCoachingMode = false;

			function getCurrentTime() {
				const now = new Date();
				return now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
			}

			/**
			 * Clears history and UI
			 */
			window.clearChat = function () {
				container.innerHTML = "";
				chatHistory = [];
				isCoachingMode = false;
				// Clear completion flag on restart
				localStorage.setItem("chat_activity_complete", "false");
			};

			/**
			 * Displays the slash command instructions
			 */
			function showCommandHelp() {
				const helpMsg =
					"Commands available:\n/feedback - Switch to Coaching Mode\n/chat - Return to simulation\n/restart - Clear history and start over";
				window.addChatMessage("System", helpMsg);
			}

			window.addChatMessage = function (sender, text) {
				typingIndicator.style.display = "none";
				const isUser = sender.toLowerCase() === "user";
				const wrapper = document.createElement("div");
				wrapper.className = `message-wrapper ${isUser ? "user" : "bot"} animate-pop`;

				const label = document.createElement("div");
				label.className = "sender-name";
				label.innerText = isUser ? "You" : sender;
				wrapper.appendChild(label);

				const bubble = document.createElement("div");
				bubble.className = "bubble";
				bubble.innerText = text;
				wrapper.appendChild(bubble);

				const time = document.createElement("div");
				time.className = "timestamp";
				time.innerText = getCurrentTime();
				wrapper.appendChild(time);

				container.appendChild(wrapper);
				container.scrollTop = container.scrollHeight;
			};

			window.showTyping = function () {
				typingIndicator.style.display = "block";
				container.scrollTop = container.scrollHeight;
			};

			async function fetchGeminiResponse(userPrompt) {
				if (!apiKey) {
					window.addChatMessage("System", "Error: Configuration incomplete.");
					return;
				}

				const cmd = userPrompt.trim().toLowerCase();

				// Slash Command: Feedback
				if (cmd === "/feedback") {
					isCoachingMode = true;
					window.addChatMessage("System", "Switching to Coaching Mode...");
					userPrompt =
						"Please analyze my performance in this conversation so far and provide constructive feedback.";
				}
				// Slash Command: Chat
				else if (cmd === "/chat") {
					isCoachingMode = false;
					window.addChatMessage("System", "Returning to simulation...");
					return;
				}
				// Slash Command: Restart
				else if (cmd === "/restart") {
					window.clearChat();
					window.addChatMessage("System", "Conversation restarted. Memory cleared.");
					showCommandHelp();
					return;
				}

				window.showTyping();
				chatHistory.push({ role: "user", parts: [{ text: userPrompt }] });

				const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;

				const activePersona = isCoachingMode ? coachPersona : systemPrompt;
				const aiLabel = isCoachingMode ? "CoachingAI" : "Customer";

				const payload = {
					contents: chatHistory,
					systemInstruction: {
						parts: [{ text: activePersona }],
					},
				};

				const fetchWithRetry = async (retries = 3, delay = 1000) => {
					try {
						const response = await fetch(url, {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
								"x-goog-api-key": apiKey,
							},
							body: JSON.stringify(payload),
						});

						if (!response.ok) {
							const errorData = await response.json();
							throw new Error(errorData.error?.message || "API_FAIL");
						}
						return await response.json();
					} catch (error) {
						if (retries > 0) {
							await new Promise((res) => setTimeout(res, delay));
							return fetchWithRetry(retries - 1, delay * 2);
						}
						throw error;
					}
				};

				try {
					const result = await fetchWithRetry();
					const aiText =
						result.candidates?.[0]?.content?.parts?.[0]?.text ||
						"No response received.";
					chatHistory.push({ role: "model", parts: [{ text: aiText }] });
					window.addChatMessage(aiLabel, aiText);

					// Update Storyline via localStorage if feedback was successfully given
					if (isCoachingMode) {
						localStorage.setItem("chat_activity_complete", "true");
					}
				} catch (error) {
					window.addChatMessage(
						"System",
						"Configuration Error: Please verify key and variables."
					);
				}
			}

			function handleSend() {
				const text = userInput.value.trim();
				if (text) {
					window.addChatMessage("user", text);
					userInput.value = "";
					sendBtn.disabled = true;
					fetchGeminiResponse(text);
				}
			}

			userInput.addEventListener("input", () => {
				sendBtn.disabled = !userInput.value.trim();
			});

			userInput.addEventListener("keypress", (e) => {
				if (e.key === "Enter") handleSend();
			});

			sendBtn.addEventListener("click", handleSend);

			function handleInboundAction(data) {
				if (data.action === "setApiKey" || (data.key && !data.action)) {
					apiKey = data.key;
					apiStatus.innerText = "Connected";
					apiStatus.className = "ready";
					window.addChatMessage("System", "Session started.");
				} else if (data.action === "setSystemPrompt") {
					systemPrompt = data.text;
					window.addChatMessage("System", "Customer persona active.");
					// Show help after initialization messages
					showCommandHelp();
				} else if (data.action === "setCoachPersona") {
					coachPersona = data.text;
				} else if (data.action === "addMessage") {
					window.addChatMessage(data.sender, data.text);
				} else if (data.action === "showTyping") {
					window.showTyping();
				} else if (data.action === "clear") {
					window.clearChat();
				}
			}

			window.addEventListener("message", function (event) {
				handleInboundAction(event.data);
			});

			// Initialize localStorage flag
			localStorage.setItem("chat_activity_complete", "false");
		</script>
	</body>
</html>
